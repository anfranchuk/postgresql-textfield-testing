## Результаты тестирования

Ниже представлены результаты тестирования производительности для различных типов текстовых полей. Тесты проводились на таблицах с 2 миллионами записей.

### Статистика размеров таблиц

**Описание таблицы:** В этой таблице показаны размеры таблиц на диске для разных типов данных. Размер индексов показывает дополнительное место, занимаемое индексами. Общий размер включает данные таблицы и все индексы. Средний размер записи вычисляется как размер данных таблицы, деленный на количество записей.

| Таблица | Тип данных | Индекс | Диапазон значений для теста| Записей | Размер таблицы | Размер индексов | Общий размер | Ср. размер записи |
|---------|------------|--------|-------------|---------|----------------|-----------------|--------------|-------------------|
| table1 | VARCHAR | Да | 1-100 | 2,000,000 | 167.12 МБ | 232.31 МБ | 399.51 МБ | 87.62 Б |
| table2 | VARCHAR | Нет | 1-100 | 2,000,000 | 167.04 МБ | 42.88 МБ | 210.00 МБ | 87.53 Б |
| table3 | VARCHAR(1000) | Нет | 500-1000 | 2,000,000 | 1.52 ГБ | 42.86 МБ | 1.56 ГБ | 814.28 Б |
| table4 | VARCHAR(10000) | Нет | 9000-10000 | 2,000,000 | 19.43 ГБ* | 42.86 МБ | 19.43 ГБ | ~10 КБ |
| table5 | VARCHAR(1000) | Да | 500-1000 | 2,000,000 | 1.52 ГБ | 2.78 ГБ | 4.30 ГБ | 814.20 Б |
| table6 | TEXT | Нет | 9000-10000 | 2,000,000 | 19.43 ГБ* | 42.86 МБ | 19.43 ГБ | ~10 КБ |
| table7 | TEXT | Нет | 500-1000 | 2,000,000 | 1.52 ГБ | 42.86 МБ | 1.56 ГБ | 814.42 Б |

\* Для больших значений PostgreSQL использует TOAST (The Oversized-Attribute Storage Technique), что увеличивает размер таблицы.

### Производительность операций

**Описание таблицы:** В этой таблице показана производительность различных операций для каждого типа таблицы. Время указано в миллисекундах (мс), операции в секунду (оп/сек) показывают пропускную способность. Тесты проводились на 1000 операциях для каждой таблицы.

#### INSERT (Вставка)

| Таблица | Среднее (мс) | P95 (мс) | P99 (мс) | Оп/сек | CV (%) |
|---------|--------------|----------|----------|--------|--------|
| table1 | 5.34 | 8.40 | 9.79 | 187.17 | 25.73 |
| table2 | 4.44 | 6.56 | 8.25 | 225.08 | 25.31 |
| table3 | 4.94 | 7.63 | 10.54 | 202.38 | 33.34 |
| table4 | 54.79 | 64.42 | 71.55 | 18.25 | 11.47 |
| table5 | 8.36 | 13.80 | 17.42 | 119.62 | 34.65 |
| table6 | 54.74 | 65.11 | 69.65 | 18.27 | 10.08 |
| table7 | 5.92 | 9.22 | 11.09 | 169.02 | 32.67 |

#### SELECT BY ID (Выборка по ID)

| Таблица | Среднее (мс) | P95 (мс) | P99 (мс) | Оп/сек | CV (%) |
|---------|--------------|----------|----------|--------|--------|
| table1 | 1.88 | 5.50 | 7.82 | 531.91 | 78.32 |
| table2 | 2.67 | 8.27 | 12.11 | 375.08 | 99.49 |
| table3 | 2.62 | 8.07 | 12.01 | 381.82 | 91.67 |
| table4 | 3.27 | 6.43 | 12.93 | 305.47 | 51.65 |
| table5 | 1.78 | 3.66 | 7.86 | 561.61 | 68.13 |
| table6 | 3.65 | 8.08 | 14.94 | 274.16 | 66.06 |
| table7 | 2.76 | 6.26 | 7.69 | 362.73 | 59.18 |

#### UPDATE BY ID (Обновление по ID)

| Таблица | Среднее (мс) | P95 (мс) | P99 (мс) | Оп/сек | CV (%) |
|---------|--------------|----------|----------|--------|--------|
| table1 | 6.25 | 10.07 | 12.38 | 160.13 | 29.31 |
| table2 | 6.01 | 9.64 | 12.14 | 166.44 | 30.66 |
| table3 | 6.96 | 10.62 | 14.55 | 143.76 | 31.24 |
| table4 | 60.43 | 75.17 | 84.48 | 16.55 | 12.96 |
| table5 | 8.49 | 13.38 | 17.17 | 117.79 | 31.79 |
| table6 | 63.07 | 81.58 | 91.52 | 15.86 | 16.36 |
| table7 | 7.18 | 10.71 | 13.11 | 139.35 | 29.16 |

#### DELETE BY ID (Удаление по ID)

| Таблица | Среднее (мс) | P95 (мс) | P99 (мс) | Оп/сек | CV (%) |
|---------|--------------|----------|----------|--------|--------|
| table1 | 6.12 | 9.73 | 11.90 | 163.45 | 32.25 |
| table2 | 5.26 | 7.88 | 10.59 | 190.02 | 26.51 |
| table3 | 6.71 | 10.70 | 12.87 | 149.13 | 30.03 |
| table4 | 9.89 | 14.09 | 16.95 | 101.08 | 27.84 |
| table5 | 5.76 | 8.89 | 10.97 | 173.48 | 27.28 |
| table6 | 7.41 | 12.36 | 17.07 | 134.95 | 34.63 |
| table7 | 7.92 | 10.75 | 12.98 | 126.21 | 24.89 |

### Пояснения к метрикам

- **Среднее (мс)**: Среднее время выполнения операции в миллисекундах
- **P95 (мс)**: 95-й перцентиль - 95% операций выполняются быстрее этого времени
- **P99 (мс)**: 99-й перцентиль - 99% операций выполняются быстрее этого времени
- **Оп/сек**: Количество операций в секунду (пропускная способность)
- **CV (%)**: Коэффициент вариации - показывает стабильность производительности (меньше = стабильнее)



## Быстрый старт

1. Убедитесь, что Docker и Docker Compose установлены
2. Создайте файл `.env` с настройками (см. раздел "Переменные окружения")
3. Запустите контейнер:

```bash
docker compose up -d
```

## Остановка

```bash
docker compose down
```

## Подключение к базе данных

- **Host**: localhost
- **Port**: 5432 (или значение из `.env`)
- **User**: postgres (или значение из `.env`)
- **Password**: postgres (или значение из `.env`)
- **Database**: testdb (или значение из `.env`)

### Пример подключения через psql:

```bash
psql -h localhost -p 5432 -U postgres -d testdb
```

### Пример подключения через Docker:

```bash
docker exec -it pg-testing-postgres psql -U postgres -d testdb
```

## Данные

Данные PostgreSQL сохраняются в папке `postgres-data/` в корне проекта. Эта папка создается автоматически при первом запуске.

**Примечание для Windows:** Убедитесь, что Docker Desktop запущен и настроен на использование WSL2 или Hyper-V. Путь к данным будет автоматически сконвертирован Docker Desktop.

## Переменные окружения

Все настройки находятся в файле `.env`. Вы можете изменить:
- `POSTGRES_USER` - имя пользователя
- `POSTGRES_PASSWORD` - пароль
- `POSTGRES_DB` - имя базы данных
- `POSTGRES_PORT` - порт для подключения

## Тестирование производительности

Проект включает скрипты для тестирования производительности PostgreSQL с различными типами текстовых полей.

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Заполнение таблиц данными

Скрипт создает 7 таблиц с разными конфигурациями и заполняет каждую тестовыми данными:

1. `table1`: VARCHAR с индексом, значения 1-100 символов
2. `table2`: VARCHAR без индекса, значения 1-100 символов
3. `table3`: VARCHAR(1000) без индекса, значения 500-1000 символов
4. `table4`: VARCHAR(10000) без индекса, значения 9000-10000 символов
5. `table5`: VARCHAR(1000) с индексом, значения 500-1000 символов
6. `table6`: TEXT без индекса, значения 9000-10000 символов
7. `table7`: TEXT без индекса, значения 500-1000 символов

**Внимание:** Заполнение большого количества записей в каждую таблицу может занять значительное время (несколько часов).

```bash
python fill_data.py
```

**Параметры командной строки:**

- `--start-from N` - начать заполнение с таблицы номер N (1-7). Пропустит все таблицы до указанной.
  ```bash
  python fill_data.py --start-from 5
  ```

- `--skip-existing` - пропускать таблицы, которые уже полностью заполнены (имеют нужное количество записей).
  ```bash
  python fill_data.py --skip-existing
  ```

**Пример:** Продолжить заполнение с 5-й таблицы, оставив первые таблицы без изменений:
```bash
python fill_data.py --start-from 5
```

### Тестирование операций

Скрипт тестирует производительность операций INSERT, SELECT, UPDATE, DELETE для всех таблиц:

```bash
python test_operations.py
```

Скрипт выполнит:
- **INSERT**: вставка новых записей
- **SELECT BY ID**: выборка по первичному ключу
- **UPDATE BY ID**: обновление записей по ID
- **DELETE BY ID**: удаление записей по ID

Для каждой операции собирается статистика:
- Среднее время выполнения
- Медианное время
- P95 и P99 перцентили
- Минимальное и максимальное время
- Стандартное отклонение
- Коэффициент вариации (стабильность производительности)
- Количество операций в секунду



### Выводы

1. **Короткие строки (1-100 символов)**: VARCHAR показывает отличную производительность, особенно с индексом
2. **Средние строки (500-1000 символов)**: VARCHAR(1000) и TEXT показывают схожую производительность
3. **Длинные строки (9000-10000 символов)**: Производительность INSERT/UPDATE значительно снижается из-за использования TOAST
4. **Индексы**: Ускоряют SELECT, но замедляют INSERT и UPDATE
5. **TEXT vs VARCHAR**: Для переменной длины строк TEXT более гибкий и показывает сопоставимую производительность
